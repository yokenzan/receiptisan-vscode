<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'nonce-<%= it.nonce %>'; img-src data:; font-src *;">
  <style>
<%~ include('styles/preview-page.css.eta') %>
  </style>
</head>
<body>
  <div id="zoom-toolbar">
    <button id="zoom-out" title="縮小">−</button>
    <button id="zoom-in" title="拡大">+</button>
    <button id="zoom-fit" title="タブ幅にフィット" class="active">⤢</button>
  </div>
  <div id="preview-container">
    <div id="preview-content"><%~ it.cliHtml %></div>
  </div>
  <script nonce="<%= it.nonce %>">
    (function () {
      const STEP = 0.1;
      const MIN = 0.1;
      const MAX = 3.0;
      let scale = 1.0;
      let fitToWidth = true;

      const content = document.getElementById('preview-content');
      const container = document.getElementById('preview-container');
      const fitBtn = document.getElementById('zoom-fit');

      function getSvgNativeWidth() {
        const svg = content.querySelector('svg');
        if (!svg) return 0;
        const width = svg.getAttribute('width');
        if (width) return parseFloat(width);
        const viewBox = svg.getAttribute('viewBox');
        if (!viewBox) return 0;
        const parts = viewBox.split(/[\s,]+/);
        return parts.length >= 4 ? parseFloat(parts[2]) : 0;
      }

      function applyZoom() {
        content.style.transform = 'scale(' + scale + ')';
        fitBtn.classList.toggle('active', fitToWidth);
      }

      function applyFit() {
        const svgWidth = getSvgNativeWidth();
        scale = svgWidth > 0 ? container.clientWidth / svgWidth : 1.0;
        applyZoom();
      }

      function manualZoom(next) {
        fitToWidth = false;
        scale = Math.min(MAX, Math.max(MIN, next));
        applyZoom();
      }

      document.getElementById('zoom-in').addEventListener('click', function () {
        manualZoom(scale + STEP);
      });
      document.getElementById('zoom-out').addEventListener('click', function () {
        manualZoom(scale - STEP);
      });
      fitBtn.addEventListener('click', function () {
        fitToWidth = true;
        applyFit();
      });
      container.addEventListener('wheel', function (event) {
        if (!event.ctrlKey) return;
        event.preventDefault();
        manualZoom(scale + (event.deltaY < 0 ? STEP : -STEP));
      }, { passive: false });

      const observer = new ResizeObserver(function () {
        if (fitToWidth) applyFit();
      });
      observer.observe(container);

      applyFit();
    })();
  </script>
</body>
</html>
