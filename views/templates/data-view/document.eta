<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'nonce-<%= it.nonce %>';">
<style>
<%~ include('../styles/data-view.css.eta') %>
</style>
</head>
<body<% if (it.layoutMode === 'horizontal') { %> class="layout-horizontal"<% } %>>
  <button id="nav-show-button" type="button" aria-controls="nav" aria-label="レセプト一覧を表示">開</button>
  <button id="settings-toggle-button" type="button" aria-label="表示設定">⚙</button>
  <div id="settings-panel" hidden>
    <div class="settings-panel-header">表示設定</div>
    <div class="settings-panel-group">
      <div class="settings-panel-label">テーマ</div>
      <div id="theme-select-container"></div>
    </div>
    <div class="settings-panel-group">
      <div class="settings-panel-label">セクション表示</div>
      <% if (it.layoutMode === 'horizontal') { %>
      <label class="settings-checkbox"><input type="checkbox" data-section-toggle="basic-info" checked />基本情報</label>
      <label class="settings-checkbox"><input type="checkbox" data-section-toggle="hoken" checked />療養の給付</label>
      <% } else { %>
      <label class="settings-checkbox"><input type="checkbox" data-section-toggle="receipt-header" checked />請求情報</label>
      <label class="settings-checkbox"><input type="checkbox" data-section-toggle="patient" checked />患者情報</label>
      <label class="settings-checkbox"><input type="checkbox" data-section-toggle="hoken" checked />療養の給付</label>
      <label class="settings-checkbox"><input type="checkbox" data-section-toggle="kyuufu" checked />食事・生活</label>
      <% } %>
      <label class="settings-checkbox"><input type="checkbox" data-section-toggle="shoubyoumei" checked />傷病名</label>
      <label class="settings-checkbox"><input type="checkbox" data-section-toggle="tekiyou" checked />摘要欄</label>
    </div>
  </div>

  <div id="nav">
    <div id="nav-header">
      <span id="nav-title">レセプト一覧</span>
      <button id="nav-hide-button" type="button" aria-controls="nav" aria-label="レセプト一覧を閉じる">閉</button>
    </div>
    <table id="nav-table">
      <thead>
        <tr><th class="nav-col nav-no">No.</th><th class="nav-col">診療年月</th><th class="nav-col">法別</th><th class="nav-col">患者番号</th><th class="nav-col">患者氏名</th></tr>
      </thead>
      <tbody>
        <% for (const navItem of it.navItems) { %>
        <tr class="nav-item" data-target="<%= navItem.id %>">
          <td class="nav-col nav-no"><%= navItem.label.idPart %></td>
          <td class="nav-col nav-ym-class">
            <span><%= navItem.label.shinryouYmWestern %></span>
            <% if (navItem.label.receiptClassLabel) { %>
            <span class="tag nav-class-badge nav-class-<%= navItem.label.receiptClassKind %>"><%= navItem.label.receiptClassLabel %></span>
            <% } %>
          </td>
          <td class="nav-col nav-law-codes"><%= navItem.label.lawCodesLabel || '-' %></td>
          <td class="nav-col nav-patient-id"><%= navItem.label.patientId %></td>
          <td class="nav-col nav-patient-name"><%= navItem.label.patientName %></td>
        </tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <div id="nav-resize-handle"></div>

  <div id="content">
    <% for (const sectionHtml of it.receiptSectionsHtml) { %>
    <%~ sectionHtml %>
    <% } %>
  </div>

  <script nonce="<%= it.nonce %>">
    (function() {
      var navLinks = document.querySelectorAll('.nav-item');
      var content = document.getElementById('content');
      var navShowButton = document.getElementById('nav-show-button');
      var navHideButton = document.getElementById('nav-hide-button');

      function applyNavHidden(hidden) {
        document.body.classList.toggle('nav-hidden', hidden);
        navShowButton.style.display = hidden ? 'inline-flex' : 'none';
        navShowButton.setAttribute('aria-expanded', hidden ? 'false' : 'true');
        navHideButton.setAttribute('aria-expanded', hidden ? 'false' : 'true');
        navShowButton.setAttribute('aria-label', 'レセプト一覧を表示');
        navHideButton.setAttribute('aria-label', 'レセプト一覧を閉じる');
      }

      navLinks.forEach(function(link) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          navLinks.forEach(function(l) { l.classList.remove('active'); });
          link.classList.add('active');
          var target = document.getElementById(link.getAttribute('data-target'));
          if (target) target.scrollIntoView({ block: 'start' });
        });
      });

      if (navLinks.length > 0) navLinks[0].classList.add('active');
      applyNavHidden(false);

      navShowButton.addEventListener('click', function() {
        applyNavHidden(false);
      });

      navHideButton.addEventListener('click', function() {
        applyNavHidden(true);
      });

      var observer = new IntersectionObserver(function(entries) {
        for (var i = 0; i < entries.length; i++) {
          if (entries[i].isIntersecting) {
            var id = entries[i].target.id;
            navLinks.forEach(function(l) {
              l.classList.toggle('active', l.getAttribute('data-target') === id);
            });
            break;
          }
        }
      }, { root: content, threshold: 0.3 });

      document.querySelectorAll('.receipt-section').forEach(function(el) {
        observer.observe(el);
      });
    })();
  </script>
  <script nonce="<%= it.nonce %>">
    <%~ it.themeScript %>
  </script>
  <script nonce="<%= it.nonce %>">
    (function() {
      var vscodeApi = acquireVsCodeApi();

      // 設定パネル開閉
      var settingsButton = document.getElementById('settings-toggle-button');
      var settingsPanel = document.getElementById('settings-panel');
      settingsButton.addEventListener('click', function(e) {
        e.stopPropagation();
        settingsPanel.hidden = !settingsPanel.hidden;
      });
      document.addEventListener('click', function(e) {
        if (!settingsPanel.contains(e.target) && e.target !== settingsButton) {
          settingsPanel.hidden = true;
        }
      });

      // セクショントグル
      var checkboxes = settingsPanel.querySelectorAll('[data-section-toggle]');
      var savedState = vscodeApi.getState() || {};
      var visibleSections = savedState.visibleSections || null;

      function applySectionVisibility(sectionName, visible) {
        var elements = document.querySelectorAll('[data-section="' + sectionName + '"]');
        elements.forEach(function(el) { el.hidden = !visible; });
      }

      function saveSectionState() {
        var sections = [];
        checkboxes.forEach(function(cb) {
          if (cb.checked) sections.push(cb.getAttribute('data-section-toggle'));
        });
        var state = vscodeApi.getState() || {};
        state.visibleSections = sections;
        vscodeApi.setState(state);
      }

      // 保存済み状態を復元
      if (visibleSections) {
        checkboxes.forEach(function(cb) {
          var section = cb.getAttribute('data-section-toggle');
          var visible = visibleSections.indexOf(section) >= 0;
          cb.checked = visible;
          applySectionVisibility(section, visible);
        });
      }

      checkboxes.forEach(function(cb) {
        cb.addEventListener('change', function() {
          var section = cb.getAttribute('data-section-toggle');
          applySectionVisibility(section, cb.checked);
          saveSectionState();
        });
      });

      // nav リサイズ
      var handle = document.getElementById('nav-resize-handle');
      var nav = document.getElementById('nav');
      var isHorizontal = document.body.classList.contains('layout-horizontal');
      var stateKey = isHorizontal ? 'navWidth' : 'navHeight';
      var minSize = isHorizontal ? 200 : 100;
      var maxRatio = 0.7;

      // 保存済みサイズを復元
      savedState = vscodeApi.getState() || {};
      if (savedState[stateKey]) {
        if (isHorizontal) {
          nav.style.width = savedState[stateKey] + 'px';
        } else {
          nav.style.maxHeight = savedState[stateKey] + 'px';
        }
      }

      handle.addEventListener('mousedown', function(e) {
        e.preventDefault();
        document.body.classList.add('nav-resizing');
        handle.classList.add('dragging');

        var onMouseMove = function(e) {
          var maxSize;
          var newSize;
          if (isHorizontal) {
            maxSize = window.innerWidth * maxRatio;
            newSize = e.clientX;
          } else {
            maxSize = window.innerHeight * maxRatio;
            newSize = window.innerHeight - e.clientY;
          }
          newSize = Math.max(minSize, Math.min(maxSize, newSize));
          if (isHorizontal) {
            nav.style.width = newSize + 'px';
          } else {
            nav.style.maxHeight = newSize + 'px';
          }
        };

        var onMouseUp = function() {
          document.body.classList.remove('nav-resizing');
          handle.classList.remove('dragging');
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);

          // サイズを保存
          var currentSize = isHorizontal
            ? parseInt(nav.style.width, 10)
            : parseInt(nav.style.maxHeight, 10);
          var state = vscodeApi.getState() || {};
          state[stateKey] = currentSize;
          vscodeApi.setState(state);
        };

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });
    })();
  </script>
</body>
</html>
